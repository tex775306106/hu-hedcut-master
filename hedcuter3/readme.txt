This is the source code for the second improvement. Recommend to output black and white images.